# AGENTS.md - Coding Agent Guidelines

**Generated:** 2026-01-19
**Commit:** 3d614a8
**Branch:** main

## Overview

HackerNews clone with TanStack Start (React Router v7), SSR on Cloudflare Workers. Features infinite scroll, LRU caching, PWA offline support, auto-refresh on focus.

**Stack**: React 19, TanStack Router, Vite 7, TypeScript (strict), Biome, Cloudflare Workers

## Commands

```bash
bun run dev              # Dev server (localhost:5173)
bun run build            # Build + typecheck
bun run deploy           # Build + deploy to Cloudflare Workers
bun run lint             # Biome lint
bun run format           # Biome format (auto-fix)
bun run typecheck        # TypeScript only
bun run typegen          # Generate Cloudflare types
# No tests configured
```

## Structure

```
app/
├── routes/              # TanStack Router file-based routes
│   ├── __root.tsx       # Root layout (html, head, body, PWA components)
│   ├── _layout.tsx      # App layout with Header, error/404 handling
│   ├── _layout/         # Nested content routes
│   │   ├── $type.tsx    # Story feeds (/top, /new, /ask, /show, /job)
│   │   ├── post.$id.tsx # Post detail + comments
│   │   └── user.$id.tsx # User profile + submissions
│   └── index.tsx        # Redirect → /top
├── components/          # Feature-based organization
│   ├── post/            # Post, Comment, Comments + CSS modules
│   ├── user/            # User + CSS module
│   ├── Header.tsx       # Navigation
│   ├── Skeleton.tsx     # Loading states
│   ├── OfflineBanner.tsx
│   └── UpdateToast.tsx
├── hooks/               # useOnlineStatus, useIntersectionObserver, useServiceWorker
├── lib/                 # fetch-data (concurrency), fetch-comments, visited-posts
├── types/               # Post, Comment, User
├── styles/              # global.css
└── routeTree.gen.ts     # AUTO-GENERATED (DO NOT EDIT)
```

## Where to Look

| Task | Location | Notes |
|------|----------|-------|
| Add story type | `app/components/Header.tsx` `items` array | Then loader handles automatically |
| API fetching | `app/lib/fetch-data.ts` | 6-connection concurrency limit |
| Comment loading | `app/lib/fetch-comments.ts` | Recursive, depth-limited (2 levels) |
| Visited tracking | `app/lib/visited-posts.ts` | LocalStorage, new comment counts |
| Route data loading | `app/routes/_layout/*.tsx` loaders | Server-side, cached 30s |
| Infinite scroll | `app/hooks/useIntersectionObserver.ts` | Used in routes |
| Offline support | `public/sw.js` + components | Stale-while-revalidate |
| CSS variables | `app/styles/global.css` | `--background`, `--secondary`, etc. |

## Data Architecture

### Caching Layers
1. **Service Worker**: Stale-while-revalidate for HN API + static assets
2. **Router**: 30s `staleTime` on loaders (SSR cache)
3. **Client LRU**: Per-type story IDs (10 entries, 1min), posts (500 entries, 1min)

### Fetching Patterns
- **Concurrency limited**: Max 6 parallel requests (Chrome connection limit)
- **Batch loading**: Comments load top 15, then expand on demand
- **Debounced refresh**: 5s minimum between auto-refreshes on focus
- **Race condition prevention**: Loading refs prevent duplicate fetches

### Error Handling
```typescript
// Non-critical (cache miss, background refresh): silent fail OK
fetchPosts(ids).then(setPosts).catch(() => {});

// Critical: throw with status
if (res.status !== 200) throw new Error(`Status ${res.status}`);
```

## Conventions

### Formatting (Biome)
- 4 spaces (2 for package.json)
- Double quotes, semicolons always, ES5 trailing commas

### TypeScript
- Strict mode, no `any`, no `!`, no `as Type`
- Use `import type { X }` for types
- Path alias: `~/` → `./app/`

### React Components
- Function declarations, not arrows: `export function Header() {}`
- Named exports, no defaults
- Colocated CSS modules: `Component.tsx` + `Component.module.css`

### CSS Modules
- BEM-like: `.post`, `.post__title`, `.post__titleVisited`
- Use CSS vars from global.css: `var(--background)`

### Route Patterns
```typescript
export const Route = createFileRoute("/_layout/$type")({
    loader: async ({ params }) => { /* SSR data fetch */ },
    component: TypeComponent,
    pendingComponent: LoadingSkeleton,
    head: ({ loaderData }) => ({ meta: [{ title: "..." }] }),
    staleTime: 30_000,
});
```

### Naming
| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase function | `function PostItem()` |
| Hooks | use* prefix | `useOnlineStatus` |
| Types | PascalCase | `type PostTypes` |
| Constants | UPPER_SNAKE | `POST_PER_PAGE` |
| CSS classes | BEM-like | `.header__linkActive` |
| Route files | param syntax | `post.$id.tsx` |

## Anti-Patterns (This Project)

- **No `any`, `!`, `as Type`**: Use proper types or `unknown`
- **No editing `routeTree.gen.ts`**: Auto-generated by router plugin
- **No editing `worker-configuration.d.ts`**: Generated by wrangler
- **No SSR data in client state**: Use loader data, not useState for initial
- **No uncached recursive fetches**: Always use LRU cache for HN API items

## Hidden Patterns

### Refresh Logic
- Auto-refresh on window focus/visibility change
- 5s debounce prevents API spam
- Invalidates both LRU cache AND router cache

### Visited Posts
- LocalStorage tracks post IDs + comment counts
- Shows "(N new)" badge for unread comments
- Updates on external link click or post view

### Comment Threads
- Collapsible with reply count when collapsed
- OP comments highlighted with "OP" label
- Lazy loading of nested replies
- Handles deleted/dead comments gracefully

### Live Relative Time
- Custom hook updates "2 hours ago" every 60s
- Prevents stale timestamps in long sessions

### Offline Mode
- OfflineBanner shows when navigator.onLine false
- Hides "load more" and refresh when offline
- Service worker serves cached content

## Cloudflare Workers

- Config: `wrangler.toml`
- `nodejs_compat` flag required for Node.js APIs
- SSR via `@tanstack/react-start/server-entry`
- `compatibility_date`: 2026-01-14

## Key Dependencies

| Package | Purpose |
|---------|---------|
| @tanstack/react-router | File-based routing |
| @tanstack/react-start | SSR framework |
| lru-cache | Client-side caching |
| date-fns | Relative time formatting |
| radash | Utilities (capitalize) |
| nprogress | Route transition progress bar |
